!function(t,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):t.supercluster=o()}(this,function(){"use strict";function a(t,o,n,i,e,r){if(!(e-i<=n)){var s=Math.floor((i+e)/2);!function t(o,n,i,e,r,s){for(;e<r;){if(600<r-e){var a=r-e+1,h=i-e+1,u=Math.log(a),p=.5*Math.exp(2*u/3),f=.5*Math.sqrt(u*p*(a-p)/a)*(h-a/2<0?-1:1),c=Math.max(e,Math.floor(i-h*p/a+f)),l=Math.min(r,Math.floor(i+(a-h)*p/a+f));t(o,n,i,c,l,s)}var d=n[2*i+s],m=e,v=r;for(g(o,n,e,i),n[2*r+s]>d&&g(o,n,e,r);m<v;){for(g(o,n,m,v),m++,v--;n[2*m+s]<d;)m++;for(;n[2*v+s]>d;)v--}n[2*e+s]===d?g(o,n,e,v):g(o,n,++v,r),v<=i&&(e=v+1),i<=v&&(r=v-1)}}(t,o,s,i,e,r%2),a(t,o,n,i,s-1,r+1),a(t,o,n,s+1,e,r+1)}}function g(t,o,n,i){e(t,n,i),e(o,2*n,2*i),e(o,2*n+1,2*i+1)}function e(t,o,n){var i=t[o];t[o]=t[n],t[n]=i}function M(t,o,n,i){var e=t-n,r=o-i;return e*e+r*r}function p(t,o,n,i,e){return new r(t,o,n,i,e)}function r(t,o,n,i,e){o=o||s,n=n||h,e=e||Array,this.nodeSize=i||64,this.points=t,this.ids=new e(t.length),this.coords=new e(2*t.length);for(var r=0;r<t.length;r++)this.ids[r]=r,this.coords[2*r]=o(t[r]),this.coords[2*r+1]=n(t[r]);a(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0)}function s(t){return t[0]}function h(t){return t[1]}function o(t){this.options=i(Object.create(this.options),t),this.trees=new Array(this.options.maxZoom+1)}function l(t){return{type:"Feature",properties:u(t),geometry:{type:"Point",coordinates:[(i=t.x,360*(i-.5)),(o=t.y,n=(180-360*o)*Math.PI/180,360*Math.atan(Math.exp(n))/Math.PI-90)]}};var o,n,i}function u(t){var o=t.numPoints,n=1e4<=o?Math.round(o/1e3)+"k":1e3<=o?Math.round(o/100)/10+"k":o;return i(i({},t.properties),{cluster:!0,cluster_id:t.id,point_count:o,point_count_abbreviated:n})}function d(t){return t/360+.5}function m(t){var o=Math.sin(t*Math.PI/180),n=.5-.25*Math.log((1+o)/(1-o))/Math.PI;return n<0?0:1<n?1:n}function i(t,o){for(var n in o)t[n]=o[n];return t}function f(t){return t.x}function c(t){return t.y}return o.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!(r.prototype={range:function(t,o,n,i){return function(t,o,n,i,e,r,s){for(var a,h,u=[0,t.length-1,0],p=[];u.length;){var f=u.pop(),c=u.pop(),l=u.pop();if(c-l<=s)for(var d=l;d<=c;d++)a=o[2*d],h=o[2*d+1],n<=a&&a<=e&&i<=h&&h<=r&&p.push(t[d]);else{var m=Math.floor((l+c)/2);a=o[2*m],h=o[2*m+1],n<=a&&a<=e&&i<=h&&h<=r&&p.push(t[m]);var v=(f+1)%2;(0===f?n<=a:i<=h)&&(u.push(l),u.push(m-1),u.push(v)),(0===f?a<=e:h<=r)&&(u.push(m+1),u.push(c),u.push(v))}}return p}(this.ids,this.coords,t,o,n,i,this.nodeSize)},within:function(t,o,n){return function(t,o,n,i,e,r){for(var s=[0,t.length-1,0],a=[],h=e*e;s.length;){var u=s.pop(),p=s.pop(),f=s.pop();if(p-f<=r)for(var c=f;c<=p;c++)M(o[2*c],o[2*c+1],n,i)<=h&&a.push(t[c]);else{var l=Math.floor((f+p)/2),d=o[2*l],m=o[2*l+1];M(d,m,n,i)<=h&&a.push(t[l]);var v=(u+1)%2;(0===u?n-e<=d:i-e<=m)&&(s.push(f),s.push(l-1),s.push(v)),(0===u?d<=n+e:m<=i+e)&&(s.push(l+1),s.push(p),s.push(v))}}return a}(this.ids,this.coords,t,o,n,this.nodeSize)}}),reduce:null,initial:function(){return{}},map:function(t){return t}},load:function(t){var o=this.options.log;o&&console.time("total time");var n="prepare "+t.length+" points";o&&console.time(n),this.points=t;for(var i,e,r,s=[],a=0;a<t.length;a++)t[a].geometry&&s.push((i=t[a],e=a,void 0,{x:d((r=i.geometry.coordinates)[0]),y:m(r[1]),zoom:1/0,id:e,parentId:-1}));this.trees[this.options.maxZoom+1]=p(s,f,c,this.options.nodeSize,Float32Array),o&&console.timeEnd(n);for(var h=this.options.maxZoom;h>=this.options.minZoom;h--){var u=+Date.now();s=this._cluster(s,h),this.trees[h]=p(s,f,c,this.options.nodeSize,Float32Array),o&&console.log("z%d: %d clusters in %dms",h,s.length,+Date.now()-u)}return o&&console.timeEnd("total time"),this},getClusters:function(t,o){var n=((t[0]+180)%360+360)%360-180,i=Math.max(-90,Math.min(90,t[1])),e=180===t[2]?180:((t[2]+180)%360+360)%360-180,r=Math.max(-90,Math.min(90,t[3]));if(360<=t[2]-t[0])n=-180,e=180;else if(e<n){var s=this.getClusters([n,i,180,r],o),a=this.getClusters([-180,i,e,r],o);return s.concat(a)}for(var h=this.trees[this._limitZoom(o)],u=h.range(d(n),m(r),d(e),m(i)),p=[],f=0;f<u.length;f++){var c=h.points[u[f]];p.push(c.numPoints?l(c):this.points[c.id])}return p},getChildren:function(t){var o=t>>5,n=t%32,i="No cluster with the specified id.",e=this.trees[n];if(!e)throw new Error(i);var r=e.points[o];if(!r)throw new Error(i);for(var s=this.options.radius/(this.options.extent*Math.pow(2,n-1)),a=e.within(r.x,r.y,s),h=[],u=0;u<a.length;u++){var p=e.points[a[u]];p.parentId===t&&h.push(p.numPoints?l(p):this.points[p.id])}if(0===h.length)throw new Error(i);return h},getLeaves:function(t,o,n){o=o||10,n=n||0;var i=[];return this._appendLeaves(i,t,o,n,0),i},getTile:function(t,o,n){var i=this.trees[this._limitZoom(t)],e=Math.pow(2,t),r=this.options.extent,s=this.options.radius/r,a=(n-s)/e,h=(n+1+s)/e,u={features:[]};return this._addTileFeatures(i.range((o-s)/e,a,(o+1+s)/e,h),i.points,o,n,e,u),0===o&&this._addTileFeatures(i.range(1-s/e,a,1,h),i.points,e,n,e,u),o===e-1&&this._addTileFeatures(i.range(0,a,s/e,h),i.points,-1,n,e,u),u.features.length?u:null},getClusterExpansionZoom:function(t){for(var o=t%32-1;o<this.options.maxZoom;){var n=this.getChildren(t);if(o++,1!==n.length)break;t=n[0].properties.cluster_id}return o},_appendLeaves:function(t,o,n,i,e){for(var r=this.getChildren(o),s=0;s<r.length;s++){var a=r[s].properties;if(a&&a.cluster?e+a.point_count<=i?e+=a.point_count:e=this._appendLeaves(t,a.cluster_id,n,i,e):e<i?e++:t.push(r[s]),t.length===n)break}return e},_addTileFeatures:function(t,o,n,i,e,r){for(var s=0;s<t.length;s++){var a=o[t[s]];r.features.push({type:1,geometry:[[Math.round(this.options.extent*(a.x*e-n)),Math.round(this.options.extent*(a.y*e-i))]],tags:a.numPoints?u(a):this.points[a.id].properties})}},_limitZoom:function(t){return Math.max(this.options.minZoom,Math.min(t,this.options.maxZoom+1))},_cluster:function(t,o){for(var n=[],i=this.options.radius/(this.options.extent*Math.pow(2,o)),e=0;e<t.length;e++){var r=t[e];if(!(r.zoom<=o)){r.zoom=o;var s=this.trees[o+1],a=s.within(r.x,r.y,i),h=r.numPoints||1,u=r.x*h,p=r.y*h,f=null;this.options.reduce&&(f=this.options.initial(),this._accumulate(f,r));for(var c=(e<<5)+(o+1),l=0;l<a.length;l++){var d=s.points[a[l]];if(!(d.zoom<=o)){d.zoom=o;var m=d.numPoints||1;u+=d.x*m,p+=d.y*m,h+=m,d.parentId=c,this.options.reduce&&this._accumulate(f,d)}}1===h?n.push(r):(r.parentId=c,n.push({x:u/h,y:p/h,zoom:1/0,id:c,parentId:-1,numPoints:h,properties:f}))}}return n},_accumulate:function(t,o){var n=o.numPoints?o.properties:this.options.map(this.points[o.id].properties);this.options.reduce(t,n)}},function(t){return new o(t)}});
