#!/bin/bash

# install init
sudo apt-get install -y ruby software-properties-common wget
sudo add-apt-repository -y "deb http://archive.ubuntu.com/ubuntu $(lsb_release -sc) universe"
sudo add-apt-repository -y ppa:ondrej/php
sudo apt-get update -y

# codedeploy init
sudo apt-get install -y gdebi
wget https://aws-codedeploy-us-east-2.s3.us-east-2.amazonaws.com/latest/install
chmod +x ./install
sudo ./install auto
sudo service codedeploy-agent start

# deps init
sudo apt-get install -y nginx php7.3 mysql-server composer
sudo apt-get install -y php7.3-mbstring php7.3-xml php7.3-bcmath php7.3-fpm php7.3-curl php-mbstring php-xml php-bcmath php-fpm php-curl

## composer init
#curl -sS https://getcomposer.org/installer | php
#sudo mv composer.phar /usr/bin/composer
#chmod +x /usr/bin/composer

# mysql init
sudo mysql -e "CREATE DATABASE IF NOT EXISTS forge; USE forge;"
sudo mysql -e "CREATE DATABASE IF NOT EXISTS laravel; USE laravel;"

# nginx
sudo service apache2 stop
sudo apt-get remove -y apache2
ipaddr=$(dig +short myip.opendns.com @resolver1.opendns.com)
sudo echo 'server {
        root /var/www/html/public;
        index index.php index.html index.htm index.nginx-debian.html;
        server_name natera-townhall.sparks-staging.com;

	location / {
        	try_files $uri $uri/ /index.php$is_args$args;
    	}

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
        }

        location ~ /\.ht {
                deny all;
        }


}
server {
        root /var/www/html/public;
        index index.php index.html index.htm index.nginx-debian.html;
        server_name '$ipaddr';

	location / {
        	try_files $uri $uri/ /index.php$is_args$args;
    	}

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
        }

        location ~ /\.ht {
                deny all;
        }


}
server {
        root /var/www/html/public;
        index index.php index.html index.htm index.nginx-debian.html;
        server_name test.sparks-staging.com;

	location / {
        	try_files $uri $uri/ /index.php$is_args$args;
    	}

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
        }

        location ~ /\.ht {
                deny all;
        }


}
server {
        root /var/www/html/public;
        index index.php index.html index.htm index.nginx-debian.html;
        server_name organhealth.natera.com;

	location / {
        	try_files $uri $uri/ /index.php$is_args$args;
    	}

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
        }

        location ~ /\.ht {
                deny all;
        }


}' > /etc/nginx/sites-available/natera.conf
sudo ln -s /etc/nginx/sites-available/natera.conf /etc/nginx/sites-enabled/natera.conf
sudo service nginx start

# perms
sudo chown -R ubuntu:ubuntu /var/www/html

# keys
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC+Q+26DtZb39PCseCDYPxI9+QO51/I6awiTkUx7Dyyvg2r7BV/4oJJrIFmbmByzkqlN6iVJaIZBlV+8cqiOoomaXTYgnbqAvNYFS4aB/IEO7cSEIPBk7vWqClA2TGAFRcSDwu0bois2y5MLjo0t+FX7JBQ+bqjmdh2Pqdz5BwmS1ajb+c12n+fuxptwm8rzIxFp+eCIVhPfV+VEKWo53DJJLbG3qRGqPLfYWNUQ6abd5nXKIvUiuSIZkSDBJoDvOcnkzUjRpyQi+op+8U5DYbacWfvfGrfAbOCGFRm1iJ5fKyeGZC3ZKR4JU+cg6V2okJ+GIeKGYZSQH0+16WMQfIwn15DILazkhCodrdwa5rXGicnxdta12qHx17SQ7GjmmHMC4HSBNSCvcB85IvD4CYAYdTfVuOide8aa1fATCqUzNcYs+PPuTY1x0CUJWi87sZAiXBQoLPXdGOmqH2dbWXkSS519h44fjCmnD0HKE2JGZoysPmXGXeBAnzYqgWvPpNfJLGbNboF16n8usi9sHlAwd2telHKXTquRLWG/qnVhIa7vpoENyIORLU+gHmvVrOAW1B6d5urIpSw9F9huTGcfAUokUyJN4/bsQjC53/TPROPR8MWdzyX7izsxp1K/ZPuUE8TGWNk8yVbIYbvcFjn6EsycdFFH6lZ1OEPuRgh7Q== lindsey@freshiscool.com" >> /home/ubuntu/.ssh/authorized_keys

# certs
# sudo add-apt-repository ppa:certbot/certbot
# sudo apt install -y python-certbot-nginx
# sudo certbot --nginx -d <domain>
